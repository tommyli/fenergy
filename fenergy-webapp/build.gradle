//import co.firefire.fenergy.db.RunSqlScriptTask

buildscript {
  ext {
    flywayVersion = '4.2.0'
  }
  repositories {
    mavenLocal()
    jcenter()
    mavenCentral()
    maven {
      url "https://plugins.gradle.org/m2/"
    }
  }
  dependencies {
    classpath("org.springframework.boot:spring-boot-gradle-plugin:$springBootVersion")
    classpath("com.google.cloud.tools:appengine-gradle-plugin:+")
    classpath "gradle.plugin.com.boxfuse.client:flyway-release:$flywayVersion"
    classpath("com.moowork.gradle:gradle-node-plugin:+")
    classpath 'com.google.cloud.tools:appengine-gradle-plugin:+'
    classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:+"
  }
}

plugins {
  id 'org.springframework.boot' version '1.5.7.RELEASE'
}
apply plugin: 'groovy'
apply plugin:'java'
apply plugin: 'kotlin'
apply plugin: 'com.google.cloud.tools.appengine'
apply plugin: 'com.moowork.node'
apply plugin: 'org.flywaydb.flyway'

description = "Fenergy Web Application Server"
group "co.firefire.fenergy.webapp"

ext {
  flywayVersion = '4.2.0'
  postgresDriverVersion = '42.1.1.jre7'
  spockVersion = '1.1-groovy-2.4'
}

repositories {
  mavenLocal()
  jcenter()
  mavenCentral()
}

dependencies {
  compile("org.springframework.boot:spring-boot-autoconfigure:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-actuator:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-cache:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-logging:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-mail:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-security:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-tomcat:$springBootVersion")
  compile("org.springframework.boot:spring-boot-starter-web:$springBootVersion")
  compile("org.springframework.cloud:spring-cloud-starter-zuul:$springCloudZuulVersion")
  compile("org.springframework.security.oauth:spring-security-oauth2:$springSecurityOAuth2Version")

  compile project(":fenergy-nem12")
  runtime project(":fenergy-db")

  testCompile("org.springframework.boot:spring-boot-test:$springBootVersion")
  testCompile("org.springframework:spring-test:$springTestVersion")
  testCompile("org.spockframework:spock-core:$spockVersion")
  testCompile("org.spockframework:spock-spring:$spockVersion")
}

def sysProps = [
  'logging.file': project.property('fenergy.logging.file'),
  'logging.path': project.property('fenergy.logging.path'),
]

bootRun {
  jvmArgs = ['-Dspring.output.ansi.enabled=always']
  systemProperties = sysProps
}

[bootRun, test].each { task ->
  configure(task) {
    systemProperties = sysProps
  }
}

appengine {
  deploy {
    stopPreviousVersion = true
    promote = true
  }
}

//flyway {
//  driver = project.property('fenergy.db.driver')
//  schemas = [project.property('fenergy.db.schema')]
//  url = project.property('fenergy.test.db.url')
//  user = project.property('fenergy.test.db.userid')
//  password = project.property('fenergy.test.db.password')
//  locations = ["classpath:db/migration"]
//  placeholderReplacement = true
//  placeholders = [
//    'schemaName': project.property('fenergy.db.schema'),
//    'dbUserId'  : project.property('fenergy.test.db.userid')
//  ]
//}
//
//task setupTestData(type: RunSqlScriptTask) {
//  url = project.property('fenergy.test.db.url')
//  userid = project.property('fenergy.test.db.userid')
//  password = project.property('fenergy.test.db.password')
//  scripts = [
//    'insert_test_data.sql'
//  ]
//}
//
//flywayClean.dependsOn classes
//flywayMigrate.dependsOn classes
//flywayMigrate.dependsOn flywayClean
//setupTestData.dependsOn flywayMigrate
//
test {
  testLogging {
    events 'passed', 'skipped', 'failed', 'standardError'
    minGranularity 2
    maxGranularity 2
  }
}

node {
  version = "6.9.1"
  npmVersion = "5.3.0"
  download = false
  nodeModulesDir = file("${project(':fenergy-ui').projectDir}")
}

task clientStart(type: NpmTask, dependsOn: 'npmInstall') {
  group = 'Angular CLI Client Tasks'
  description = 'Build client for development'
  args = ['run', 'start']
}

task clientBuild(type: NpmTask, dependsOn: 'npmInstall') {
  group = 'Angular CLI Client Tasks'
  description = 'Build client for development'
  args = ['run', 'build']
}

task clientTest(type: NpmTask, dependsOn: 'npmInstall') {
  group = 'Angular CLI Client Tasks'
  description = "Run client tests"
  args = ['run', 'test']
}

task clientBuildProd(type: NpmTask, dependsOn: 'npmInstall') {
  group = 'Angular CLI Client Tasks'
  description = 'Build client for production'
  args = ['run', 'buildProd']
}

bootRun.dependsOn(clientBuild)
//jar.dependsOn(clientBuildProd)
